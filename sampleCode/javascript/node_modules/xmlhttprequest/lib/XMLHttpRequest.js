var Url=require("url"),spawn=require("child_process").spawn,fs=require("fs");exports.XMLHttpRequest=function(){"use strict";var e,t,r=this,s=require("http"),n=require("https"),o={},a=!1,i={"User-Agent":"node-XMLHttpRequest",Accept:"*/*"},h={},d={},u=["accept-charset","accept-encoding","access-control-request-headers","access-control-request-method","connection","content-length","content-transfer-encoding","cookie","cookie2","date","expect","host","keep-alive","origin","referer","te","trailer","transfer-encoding","upgrade","via"],c=["TRACE","TRACK","CONNECT"],f=!1,l=!1,p={};this.UNSENT=0,this.OPENED=1,this.HEADERS_RECEIVED=2,this.LOADING=3,this.DONE=4,this.readyState=this.UNSENT,this.onreadystatechange=null,this.responseText="",this.responseXML="",this.status=null,this.statusText=null,this.withCredentials=!1;var E=function(e){return a||e&&u.indexOf(e.toLowerCase())===-1},y=function(e){return e&&c.indexOf(e)===-1};this.open=function(e,t,r,s,n){if(this.abort(),l=!1,!y(e))throw new Error("SecurityError: Request method not allowed");o={method:e,url:t.toString(),async:"boolean"!=typeof r||r,user:s||null,password:n||null},S(this.OPENED)},this.setDisableHeaderCheck=function(e){a=e},this.setRequestHeader=function(e,t){if(this.readyState!==this.OPENED)throw new Error("INVALID_STATE_ERR: setRequestHeader can only be called when state is OPEN");if(!E(e))return void console.warn('Refused to set unsafe header "'+e+'"');if(f)throw new Error("INVALID_STATE_ERR: send flag is true");e=d[e.toLowerCase()]||e,d[e.toLowerCase()]=e,h[e]=h[e]?h[e]+", "+t:t},this.getResponseHeader=function(e){return"string"==typeof e&&this.readyState>this.OPENED&&t&&t.headers&&t.headers[e.toLowerCase()]&&!l?t.headers[e.toLowerCase()]:null},this.getAllResponseHeaders=function(){if(this.readyState<this.HEADERS_RECEIVED||l)return"";var e="";for(var r in t.headers)"set-cookie"!==r&&"set-cookie2"!==r&&(e+=r+": "+t.headers[r]+"\r\n");return e.substr(0,e.length-2)},this.getRequestHeader=function(e){return"string"==typeof e&&d[e.toLowerCase()]?h[d[e.toLowerCase()]]:""},this.send=function(a){if(this.readyState!==this.OPENED)throw new Error("INVALID_STATE_ERR: connection must be opened before send() is called");if(f)throw new Error("INVALID_STATE_ERR: send has already been called");var u,c=!1,p=!1,E=Url.parse(o.url);switch(E.protocol){case"https:":c=!0;case"http:":u=E.hostname;break;case"file:":p=!0;break;case void 0:case null:case"":u="localhost";break;default:throw new Error("Protocol not supported.")}if(p){if("GET"!==o.method)throw new Error("XMLHttpRequest: Only GET method is supported");if(o.async)fs.readFile(E.pathname,"utf8",function(e,t){e?r.handleError(e):(r.status=200,r.responseText=t,S(r.DONE))});else try{this.responseText=fs.readFileSync(E.pathname,"utf8"),this.status=200,S(r.DONE)}catch(e){this.handleError(e)}}else{var y=E.port||(c?443:80),w=E.pathname+(E.search?E.search:"");for(var v in i)d[v.toLowerCase()]||(h[v]=i[v]);if(h.Host=u,c&&443===y||80===y||(h.Host+=":"+E.port),o.user){"undefined"==typeof o.password&&(o.password="");var N=new Buffer(o.user+":"+o.password);h.Authorization="Basic "+N.toString("base64")}"GET"===o.method||"HEAD"===o.method?a=null:a?(h["Content-Length"]=Buffer.isBuffer(a)?a.length:Buffer.byteLength(a),h["Content-Type"]||(h["Content-Type"]="text/plain;charset=UTF-8")):"POST"===o.method&&(h["Content-Length"]=0);var T={host:u,port:y,path:w,method:o.method,headers:h,agent:!1,withCredentials:r.withCredentials};if(l=!1,o.async){var g=c?n.request:s.request;f=!0,r.dispatchEvent("readystatechange");var C=function s(n){if(t=n,301===t.statusCode||302===t.statusCode||303===t.statusCode||307===t.statusCode){o.url=t.headers.location;var a=Url.parse(o.url);u=a.hostname;var i={hostname:a.hostname,port:a.port,path:a.path,method:303===t.statusCode?"GET":o.method,headers:h,withCredentials:r.withCredentials};return e=g(i,s).on("error",D),void e.end()}t.setEncoding("utf8"),S(r.HEADERS_RECEIVED),r.status=t.statusCode,t.on("data",function(e){e&&(r.responseText+=e),f&&S(r.LOADING)}),t.on("end",function(){f&&(S(r.DONE),f=!1)}),t.on("error",function(e){r.handleError(e)})},D=function(e){r.handleError(e)};e=g(T,C).on("error",D),a&&e.write(a),e.end(),r.dispatchEvent("loadstart")}else{var O=".node-xmlhttprequest-content-"+process.pid,R=".node-xmlhttprequest-sync-"+process.pid;fs.writeFileSync(R,"","utf8");for(var q="var http = require('http'), https = require('https'), fs = require('fs');var doRequest = http"+(c?"s":"")+".request;var options = "+JSON.stringify(T)+";var responseText = '';var req = doRequest(options, function(response) {response.setEncoding('utf8');response.on('data', function(chunk) {  responseText += chunk;});response.on('end', function() {fs.writeFileSync('"+O+"', JSON.stringify({err: null, data: {statusCode: response.statusCode, headers: response.headers, text: responseText}}), 'utf8');fs.unlinkSync('"+R+"');});response.on('error', function(error) {fs.writeFileSync('"+O+"', JSON.stringify({err: error}), 'utf8');fs.unlinkSync('"+R+"');});}).on('error', function(error) {fs.writeFileSync('"+O+"', JSON.stringify({err: error}), 'utf8');fs.unlinkSync('"+R+"');});"+(a?"req.write('"+JSON.stringify(a).slice(1,-1).replace(/'/g,"\\'")+"');":"")+"req.end();",L=spawn(process.argv[0],["-e",q]);fs.existsSync(R););var m=JSON.parse(fs.readFileSync(O,"utf8"));L.stdin.end(),fs.unlinkSync(O),m.err?r.handleError(m.err):(t=m.data,r.status=m.data.statusCode,r.responseText=m.data.text,S(r.DONE))}}},this.handleError=function(e){this.status=0,this.statusText=e,this.responseText=e.stack,l=!0,S(this.DONE),this.dispatchEvent("error")},this.abort=function(){e&&(e.abort(),e=null),h=i,this.status=0,this.responseText="",this.responseXML="",l=!0,this.readyState===this.UNSENT||this.readyState===this.OPENED&&!f||this.readyState===this.DONE||(f=!1,S(this.DONE)),this.readyState=this.UNSENT,this.dispatchEvent("abort")},this.addEventListener=function(e,t){e in p||(p[e]=[]),p[e].push(t)},this.removeEventListener=function(e,t){e in p&&(p[e]=p[e].filter(function(e){return e!==t}))},this.dispatchEvent=function(e){if("function"==typeof r["on"+e]&&r["on"+e](),e in p)for(var t=0,s=p[e].length;t<s;t++)p[e][t].call(r)};var S=function(e){e!=r.LOADING&&r.readyState===e||(r.readyState=e,(o.async||r.readyState<r.OPENED||r.readyState===r.DONE)&&r.dispatchEvent("readystatechange"),r.readyState!==r.DONE||l||(r.dispatchEvent("load"),r.dispatchEvent("loadend")))}};